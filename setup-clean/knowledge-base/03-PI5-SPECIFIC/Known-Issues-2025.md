# üêõ Known Issues 2025 - Supabase ARM64 Raspberry Pi 5

> Issues document√©es, v√©rifi√©es sur sources officielles et community-tested
> Derni√®re mise √† jour : Octobre 2025

---

## üìä Vue d'Ensemble

Ce document consolide :
- ‚úÖ **Issues GitHub officielles** Supabase (2024-2025)
- ‚úÖ **Recherches web** r√©centes (Reddit, Forums, Stack Overflow)
- ‚úÖ **Solutions test√©es** par la communaut√© Pi 5
- ‚úÖ **Workarounds** document√©s et valid√©s

---

## üî¥ ISSUES CRITIQUES (Bloquantes)

### 1. Page Size 16KB Incompatibilit√© PostgreSQL ‚ö†Ô∏è **CRITIQUE**

R√©f√©rence principale :
- Issue GitHub Supabase: [#30640](https://github.com/supabase/supabase/issues/30640) ‚Äî Unable to run self-hosted Supabase on Raspberry Pi OS (64-bit)
- Kernel Pi 5 (BCM2712) par d√©faut en 16KB: `CONFIG_ARM64_16K_PAGES=y` dans le defconfig officiel (preuve compile-time) ‚Äî voir `bcm2712_defconfig` [rpi-6.6.y](https://raw.githubusercontent.com/raspberrypi/linux/rpi-6.6.y/arch/arm64/configs/bcm2712_defconfig)

#### Sympt√¥mes

```
ERROR: page size mismatch: expected 4096, got 16384
FATAL: database files are incompatible with server
```

ou

```
<jemalloc>: Unsupported system page size: 16384
docker: Error response from daemon: failed to create task for container: failed to create shim task
```

#### Cause racine (v√©rifi√©e)

- Raspberry Pi OS pour Pi 5 utilise par d√©faut un noyau ARM64 avec pages m√©moire de 16KB (CONFIG ARM64_16K_PAGES activ√©e).
- La majorit√© des binaires/containers (PostgreSQL, jemalloc utilis√©e par certains services) sont construits pour 4KB et √©chouent quand la page = 16KB.
- Cons√©quence: `supabase-db` (Postgres) et d‚Äôautres services peuvent ne pas d√©marrer (erreurs pagesize/jemalloc dans #30640).

#### Impact

- üî¥ **Installation impossible** sans ce fix
- üî¥ **Service `supabase-db` en crash loop**
- üî¥ **Tous les services d√©pendants √©chouent**

#### Solutions viables (v√©rifi√©es) et validations

Important: La taille de page m√©moire est un param√®tre de compilation du noyau (compile-time), pas un simple param√®tre `cmdline.txt`. Il n‚Äôexiste pas d‚Äôoption runtime g√©n√©rique `pagesize=4k` pour forcer 4KB. Preuve: le defconfig Pi 5 active `CONFIG_ARM64_16K_PAGES=y` [bcm2712_defconfig](https://raw.githubusercontent.com/raspberrypi/linux/rpi-6.6.y/arch/arm64/configs/bcm2712_defconfig).

- Option A (recommand√©e): Utiliser un noyau 4KB pour Pi 5
  - Installer/d√©marrer un noyau ARM64 Pi 5 compil√© avec `CONFIG_ARM64_4K_PAGES`. Cela peut n√©cessiter l‚Äôinstallation d‚Äôune variante 4KB du noyau Raspberry Pi OS ou l‚Äôutilisation d‚Äôune distribution qui fournit un noyau 4KB par d√©faut sur Pi 5.
  - Alternative pratique: utiliser Ubuntu/Debian arm64 r√©cents sur Pi 5 (g√©n√©ralement 4KB par d√©faut). V√©rifier avec `getconf PAGESIZE`.
- Option B: Compiler soi‚Äëm√™me un noyau Pi 5 avec pages 4KB (avanc√©)
  - Partir du repo `raspberrypi/linux` (branche rpi-6.6.y) et activer `CONFIG_ARM64_4K_PAGES` plut√¥t que `ARM64_16K_PAGES`.
- Option C: Contournements partiels
  - D√©sactiver certains services sensibles √† 16KB (ex: `vector`, cf. Issue 2) ne r√®gle pas Postgres. Utile seulement si Postgres fonctionne d√©j√† en 4KB.

Validation apr√®s reboot (quelle que soit la m√©thode):
```bash
getconf PAGESIZE  # doit retourner 4096
```

#### Notes & r√©f√©rences communaut√©

- Discussion forum Raspberry Pi: [Why to run 16k page size for RPi5?](https://forums.raspberrypi.com/viewtopic.php?t=361390) ‚Äî gain perf ~7% avec 16KB vs compatibilit√© logicielle bien meilleure en 4KB.
- Issue Supabase: [#30640](https://github.com/supabase/supabase/issues/30640) ‚Äî captures/rapports confirment erreurs 16KB.

#### Statut 2025

- üü° Issue ouverte c√¥t√© Supabase (comportements li√©s au 16KB non support√©s dans de multiples images).
- üü¢ Workaround stable: ex√©cuter un noyau 4KB (distro ou kernel alternatif) ‚Äî Postgres et services dependants d√©marrent.
- üî¥ Support 16KB c√¥t√© binaires tiers (jemalloc/Postgres/alpine) non g√©n√©ralis√©.

---

### 2. supabase-vector (Vector) incompatible 16KB

R√©f√©rences:
- Issue li√©e: [#30640](https://github.com/supabase/supabase/issues/30640)

#### Sympt√¥mes

```
supabase-vector | <jemalloc>: Unsupported system page size
supabase-vector | Segmentation fault (core dumped)
```

#### Cause

- Le container `vector` (timberio/vector) utilise `jemalloc` construit pour 4KB.
- Avec un noyau 16KB, `jemalloc` √©choue (`Unsupported system page size`) et le processus crash.

#### Solutions

**Option A** : Fix page size (voir Issue #1) ‚Üí R√©sout aussi vector

**Option B** : D√©sactiver vector dans docker-compose.yml

```yaml
# Commenter section compl√®te
# vector:
#   container_name: supabase-vector
#   image: timberio/vector:0.28.1-alpine
#   ...

# Supprimer d√©pendances vector dans autres services
services:
  analytics:
    depends_on:
      # vector:  # ‚Üê COMMENTER
      #   condition: service_healthy
```

**Option C** : Image alternative (non officiel) ‚Äî √† √©viter en prod, pr√©f√©rer 4KB c√¥t√© OS.

#### Recommandation

üéØ **Fixer page size √† 4KB** ‚Üí R√©sout vector ET PostgreSQL ensemble

---

## üü° ISSUES MAJEURES (Fr√©quentes)

### 3. Auth Service ‚Äì erreur de cast UUID/Text (cas observ√©)

R√©f√©rence migrations Auth:
- `20221208132122_backfill_email_last_sign_in_at.up.sql` (Supabase Auth) ‚Äî voir le repo officiel: [migrations](https://github.com/supabase/auth/tree/master/migrations)

#### Sympt√¥mes

```
ERROR: operator does not exist: uuid = text (SQLSTATE 42883)
HINT: No operator matches the given name and argument types
FILE: /migrations/20221208132122_backfill_email_last_sign_in_at.up.sql
```

Service `supabase-auth` en restart loop.

#### Cause possible

- Selon certaines installations, des migrations ou requ√™tes custom peuvent comparer `uuid` et `text` sans cast explicite, ce qui peut d√©clencher `operator does not exist: uuid = text` (SQLSTATE 42883) selon la configuration.
- Les migrations officielles r√©centes utilisent g√©n√©ralement un cast c√¥t√© `text` (ex: `id = user_id::text`). Probl√®me surtout observ√© dans environnements divergents ou versions ant√©rieures.

#### Pistes de contournement (si l‚Äôerreur appara√Æt)

Pr√©f√©rer corriger la requ√™te fautive avec des casts explicites (`::text` ou `::uuid`) plut√¥t que d‚Äôajouter un op√©rateur global `uuid = text`.

Exemples utiles:
```sql
-- Comparer en text c√¥t√© gauche/droite de fa√ßon explicite
-- (√† adapter √† la requ√™te r√©elle qui √©choue)
... WHERE identities.id = identities.user_id::text;
-- ou
... WHERE identities.id::uuid = identities.user_id;
```

Si n√©cessaire, appliquer la migration incrimin√©e manuellement apr√®s correction, puis red√©marrer `auth`.

#### Solution Manuelle (si besoin)

```bash
cd ~/stacks/supabase

# Ex√©cuter le SQL fix
docker compose exec db psql -U postgres -d postgres <<'EOF'
CREATE OR REPLACE FUNCTION uuid_text_eq(uuid, text) RETURNS boolean AS
$func$ SELECT $1::text = $2; $func$ LANGUAGE SQL IMMUTABLE;
CREATE OPERATOR = (LEFTARG = uuid, RIGHTARG = text, FUNCTION = uuid_text_eq);
EOF

# Red√©marrer auth
docker compose restart auth
```

#### Statut 2025

- üü° Probl√®me non syst√©matique; d√©pend des versions et des requ√™tes.
- ‚úÖ Solution: utiliser des casts explicites dans les requ√™tes/migrations affect√©es.

---

### 4. Realtime ‚Äì variables d‚Äôenvironnement manquantes (encryption/cl√©)

R√©f√©rences officielles:
- README Realtime (liste des env vars): [supabase/realtime](https://github.com/supabase/realtime/blob/main/README.md)

#### Sympt√¥mes

```
[error] Erlang error: {:badarg, {~c"api_ng.c", 228}, ~c"Bad key"}
[error] crypto_one_time(:aes_128_ecb, nil, ...)
[error] Realtime.Tenants.Encrypt.decrypt/2
```

Service `supabase-realtime` crash au d√©marrage.

#### Cause

- Realtime s‚Äôappuie sur des variables telles que `DB_ENC_KEY`, `SECRET_KEY_BASE`, `JWT_SECRET`, etc. Si `DB_ENC_KEY` est requis pour chiffrer/d√©chiffrer des champs (tenants/extensions) et n‚Äôest pas d√©fini, certaines op√©rations peuvent √©chouer.

#### Recommandations

- D√©finir des valeurs s√ªres et persistantes:
  - `DB_ENC_KEY`: cl√© utilis√©e pour chiffrer certains champs internes. Recommandation: 16 caract√®res (cf. README Realtime), pas n√©cessairement hexad√©cimal.
  - `SECRET_KEY_BASE`: secret Phoenix pour signer les cookies. Recommandation: ~64 caract√®res.
  - `JWT_SECRET`/`API_JWT_SECRET`: coh√©rents avec votre configuration JWT.
  - `APP_NAME`: optionnel (nom d‚Äôinstance).

#### Exemple de configuration (.env / compose)

```yaml
realtime:
  environment:
    DB_HOST: "db"
    DB_PORT: "5432"
    DB_USER: "supabase_admin"
    DB_PASSWORD: "${POSTGRES_PASSWORD}"
    DB_NAME: "postgres"
    DB_SSL: "disable"

    DB_ENC_KEY: "${DB_ENC_KEY}"          # 16 caract√®res recommand√©s
    SECRET_KEY_BASE: "${SECRET_KEY_BASE}" # ~64 caract√®res recommand√©s

    JWT_SECRET: "${JWT_SECRET}"
    SLOT_NAME: "supabase_realtime_slot"
    PUBLICATIONS: '["supabase_realtime"]'
    REPLICATION_MODE: "RLS"
    APP_NAME: "supabase_realtime"
    PORT: "4000"
```

#### Statut 2025

- üü¢ Bien document√© dans le README Realtime; certaines variables sont n√©cessaires selon les fonctionnalit√©s activ√©es.
- üü° Les templates `.env` g√©n√©riques peuvent omettre ces cl√©s ‚Äî ajouter manuellement.

---

### 5. Docker Compose YAML Corruption ‚Äì Indentation

**Issue** : Corruption silencieuse lors de sed/awk dans scripts

#### Sympt√¥mes

```
yaml: line 95: did not find expected key
Error response from daemon: invalid compose project
```

#### Cause

- Scripts utilisent `sed` pour injecter variables
- Indentation YAML cass√©e (espaces vs tabs)
- `APP_NAME` souvent mal indent√© (8 espaces au lieu de 6)

#### Solution Pr√©ventive (Scripts)

```bash
# Utiliser sed avec contexte d'indentation
sed -i '/environment:/a\      APP_NAME: "supabase_realtime"' docker-compose.yml
#                             ^^^^^^ 6 espaces exactement

# Validation post-modification
docker compose config > /dev/null
if [ $? -ne 0 ]; then
  echo "ERROR: YAML invalide d√©tect√©"
  exit 1
fi
```

#### Fix manuel

```bash
cd ~/stacks/supabase

# Valider YAML
docker compose config

# Si erreur, v√©rifier indentation
nano docker-compose.yml
# Chercher "APP_NAME" et v√©rifier 6 espaces avant

# Alternative : r√©g√©n√©rer docker-compose.yml
sudo ./scripts/setup-week2-supabase-final.sh
```

---

## üü¢ ISSUES MINEURES (Connues)

### 6. Healthchecks Timeouts sur ARM64

#### Sympt√¥mes

```
supabase-db    | Up 2 minutes (health: starting)
supabase-auth  | Up 3 minutes (unhealthy)
```

Services fonctionnels mais marqu√©s unhealthy.

#### Cause

- Healthchecks configur√©s pour x86 (plus rapide)
- ARM64 Pi 5 plus lent ‚Üí timeouts pr√©matur√©s

#### Solution

Augmenter timeouts dans docker-compose.yml :

```yaml
db:
  healthcheck:
    interval: 45s      # au lieu de 30s
    timeout: 20s       # au lieu de 10s
    retries: 8         # au lieu de 5
    start_period: 90s  # au lieu de 60s
```

---

### 7. Memory limits trop bas pour Pi 5 16GB

#### Sympt√¥mes

```
OOMKilled
Container exceeded memory limit
```

#### Cause

- Limits m√©moire configur√©s pour 4-8GB RAM
- Pi 5 avec 16GB peut g√©rer plus

#### Solution

```yaml
services:
  db:
    deploy:
      resources:
        limits:
          memory: 2G      # au lieu de 1G
  auth:
    deploy:
      resources:
        limits:
          memory: 512M    # au lieu de 256M
```

---

## üìà Issues r√©solues (historique)

### ‚úÖ ARM64 Images Indisponibles (2021-2023)

**Issue GitHub** : [#2954](https://github.com/supabase/supabase/issues/2954) - Support aarch64 for Compose setup

**Statut 2025** : üü¢ R√©solu
- Toutes les images core disponibles en ARM64
- Tags multi-arch support√©s
- Supabase CLI ARM64 disponible

---

### ‚úÖ Docker daemon: recommandations logs (2024‚Äì2025)

Suggestion (g√©n√©rique) pour limiter la taille des logs conteneurs:

```json
// /etc/docker/daemon.json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

(Ne pas annoncer de d√©pr√©ciation non v√©rifi√©e; se r√©f√©rer aux release notes Docker 27 si n√©cessaire.)

---

## üîç R√©f√©rences v√©rifi√©es

- Supabase ‚Äî Issue Pi 5 / 16KB: https://github.com/supabase/supabase/issues/30640
- Raspberry Pi Linux ‚Äî defconfig Pi 5 (16KB pages): https://raw.githubusercontent.com/raspberrypi/linux/rpi-6.6.y/arch/arm64/configs/bcm2712_defconfig
- Supabase Realtime ‚Äî variables d‚Äôenvironnement: https://github.com/supabase/realtime/blob/main/README.md
- Supabase ‚Äî ARM64 / multi-arch (historique): https://github.com/supabase/supabase/issues/2954
- Raspberry Pi Forums ‚Äî 16KB vs 4KB: https://forums.raspberrypi.com/viewtopic.php?t=361390

---

## üìä Notes et conseils pratiques

- Toujours valider `getconf PAGESIZE` avant d‚Äôinvestiguer des erreurs Postgres/jemalloc.
- Pr√©f√©rer SSD/NVMe via USB 3 pour de meilleures perfs I/O; √©viter les cartes SD lentes pour des bases de donn√©es.
- Sur Pi 5 8‚Äì16GB, ajuster les healthchecks/ressources (voir sections 6‚Äì7) pour limiter les faux ¬´ unhealthy ¬ª.

---

## üõ†Ô∏è Outil de diagnostic rapide

### Script Validation Pi 5 (Community)

```bash
#!/bin/bash
# pi5-supabase-check.sh - Community diagnostic tool

echo "=== Raspberry Pi 5 Supabase Compatibility Check ==="

# Page size
PAGESIZE=$(getconf PAGESIZE)
if [ "$PAGESIZE" = "4096" ]; then
  echo "‚úÖ Page size: 4096 (OK)"
else
  echo "‚ùå Page size: $PAGESIZE (FAIL - must be 4096)"
fi

# RAM
RAM=$(free -g | awk '/^Mem:/{print $2}')
if [ "$RAM" -ge 8 ]; then
  echo "‚úÖ RAM: ${RAM}GB (OK)"
else
  echo "‚ö†Ô∏è  RAM: ${RAM}GB (WARNING - 8GB+ recommended)"
fi

# Docker
if command -v docker &> /dev/null; then
  echo "‚úÖ Docker installed"
else
  echo "‚ùå Docker NOT installed"
fi

# Architecture
ARCH=$(uname -m)
if [ "$ARCH" = "aarch64" ]; then
  echo "‚úÖ Architecture: ARM64 (OK)"
else
  echo "‚ùå Architecture: $ARCH (FAIL - must be aarch64)"
fi
```

---

## üîÆ Roadmap & points d‚Äôattention

- Suivre le [changelog Supabase](https://supabase.com/changelog) et les issues li√©es au self-hosting ARM64.
- Le support 16KB c√¥t√© √©cosyst√®me container reste limit√©; privil√©gier 4KB pour compatibilit√©.

---

## üìö Ressources Externes

### Issues GitHub actives

- [#30640](https://github.com/supabase/supabase/issues/30640) - Pi OS 64-bit issues (üî¥ Ouvert)
- [#2954](https://github.com/supabase/supabase/issues/2954) - ARM64 support (üü¢ Ferm√©)
- [#4887](https://github.com/supabase/supabase/issues/4887) - Docker images arch (üü¢ Ferm√©)

### Forums & communaut√©s

- [r/Supabase](https://reddit.com/r/Supabase) - Subreddit actif
- [Raspberry Pi Forums](https://forums.raspberrypi.com) - Section Docker
- [Supabase Discord](https://discord.supabase.com) - Canal #self-hosting

### Docs officielles

- [Self-Hosting Docker](https://supabase.com/docs/guides/self-hosting/docker)
- [Realtime Configuration](https://supabase.com/docs/reference/self-hosting-realtime)
- [Auth (GoTrue) Docs](https://supabase.com/docs/reference/self-hosting-auth)

---

## üí° Conseils G√©n√©raux

### Avant de D√©buter

1. ‚úÖ **Lire** ce document enti√®rement
2. ‚úÖ **Fixer page size** avant toute installation
3. ‚úÖ **Utiliser** scripts automatis√©s test√©s
4. ‚úÖ **Sauvegarder** `.env` et config initiales

### Pendant Installation

1. ‚è±Ô∏è **Patienter** : ARM64 plus lent pour t√©l√©charger images
2. üìä **Monitorer** : `docker stats` pour voir progression
3. üìù **Logger** : Sauvegarder outputs scripts

### Apr√®s Installation

1. ‚úÖ **Valider** : Script `supabase-health.sh`
2. üíæ **Backup** : Premier backup imm√©diatement
3. üìñ **Documenter** : Vos sp√©cificit√©s/modifications

---

<p align="center">
  <strong>üìå Document mis √† jour r√©guli√®rement avec nouvelles issues/solutions</strong>
</p>

<p align="center">
  <a href="../README.md">‚Üê Retour Index</a> ‚Ä¢
  <a href="Page-Size-Fix.md">Fix Page Size ‚Üí</a>
</p>
