# üîÄ Approche Hybride : Combiner Tunnel G√©n√©rique + Tunnels D√©di√©s

> **Utilisez le meilleur des deux mondes : tunnel g√©n√©rique pour apps non-critiques + tunnels d√©di√©s pour apps sensibles**

---

## üìä Concept

Vous pouvez **combiner** les deux approches sur le m√™me serveur :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     RASPBERRY PI 5                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  üì¶ Tunnel G√©n√©rique (cloudflared-tunnel)                  ‚îÇ
‚îÇ     ‚îú‚îÄ‚îÄ‚Üí blog.domain.com ‚Üí blog-app:80                     ‚îÇ
‚îÇ     ‚îú‚îÄ‚îÄ‚Üí portfolio.domain.com ‚Üí portfolio:3000             ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚Üí demo.domain.com ‚Üí demo-app:8080                   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  üîí Tunnel CertiDoc D√©di√© (certidoc-tunnel)                ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚Üí certidoc.domain.com ‚Üí certidoc-frontend:80        ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  üîí Tunnel Supabase D√©di√© (supabase-tunnel)                ‚îÇ
‚îÇ     ‚îú‚îÄ‚îÄ‚Üí api.domain.com ‚Üí supabase-kong:8000              ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚Üí studio.domain.com ‚Üí supabase-studio:3000         ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Quand Utiliser l'Approche Hybride ?

### ‚úÖ Utilisez un **Tunnel G√©n√©rique** pour :

- **Apps non-critiques** (blog, portfolio, sites vitrine)
- **Apps en d√©veloppement** (tests, d√©mos)
- **Apps avec peu de trafic**
- **Apps sans donn√©es sensibles**

**Avantages** :
- √âconomie RAM (1 tunnel = 50 MB pour N apps)
- Gestion centralis√©e facile
- Ajout/suppression rapide

---

### üîí Utilisez des **Tunnels D√©di√©s** pour :

- **Apps en production critique** (CertiDoc, plateforme e-commerce)
- **Apps avec donn√©es sensibles** (Supabase, bases de donn√©es)
- **Apps n√©cessitant isolation totale**
- **Apps avec fort trafic** (√©viter contention)

**Avantages** :
- Isolation totale (un tunnel plante ‚â† autres apps impact√©es)
- Monitoring granulaire par app
- Credentials s√©par√©es (s√©curit√© renforc√©e)
- Configuration ind√©pendante

---

## üõ†Ô∏è Installation Hybride

### √âtape 1 : Installer le Tunnel G√©n√©rique

```bash
# Installation tunnel g√©n√©rique
sudo bash /path/to/01-setup-generic-tunnel.sh

# Ajouter apps non-critiques
sudo bash 02-add-app-to-tunnel.sh \
  --name blog \
  --hostname blog.domain.com \
  --service blog-app:80

sudo bash 02-add-app-to-tunnel.sh \
  --name portfolio \
  --hostname portfolio.domain.com \
  --service portfolio-app:3000
```

---

### √âtape 2 : Installer Tunnels D√©di√©s pour Apps Critiques

#### Tunnel CertiDoc D√©di√©

```bash
# 1. Cr√©er dossier d√©di√©
mkdir -p /home/pi/tunnels/certidoc
cd /home/pi/tunnels/certidoc

# 2. Authentifier Cloudflare (si pas d√©j√† fait)
cloudflared tunnel login

# 3. Cr√©er tunnel d√©di√©
cloudflared tunnel create certidoc-tunnel

# 4. Configurer tunnel
cat > config.yml << 'EOF'
tunnel: <TUNNEL_ID>
credentials-file: /etc/cloudflared/credentials.json

ingress:
  - hostname: certidoc.domain.com
    service: http://certidoc-frontend:80
    originRequest:
      noTLSVerify: false

  - service: http_status:404
EOF

# 5. Copier credentials
sudo cp /root/.cloudflared/<TUNNEL_ID>.json ./credentials.json
chmod 600 credentials.json

# 6. Cr√©er docker-compose.yml
cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  certidoc-tunnel:
    image: cloudflare/cloudflared:latest
    container_name: certidoc-tunnel
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./config.yml:/etc/cloudflared/config.yml:ro
      - ./credentials.json:/etc/cloudflared/credentials.json:ro
    networks:
      - traefik_network
    healthcheck:
      test: ["CMD-SHELL", "pgrep cloudflared || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  traefik_network:
    external: true
    name: traefik_network
EOF

# 7. D√©marrer tunnel CertiDoc
docker compose up -d
```

---

#### Tunnel Supabase D√©di√©

```bash
# 1. Cr√©er dossier d√©di√©
mkdir -p /home/pi/tunnels/supabase
cd /home/pi/tunnels/supabase

# 2. Cr√©er tunnel
cloudflared tunnel create supabase-tunnel

# 3. Configurer tunnel
cat > config.yml << 'EOF'
tunnel: <TUNNEL_ID>
credentials-file: /etc/cloudflared/credentials.json

ingress:
  - hostname: api.domain.com
    service: http://supabase-kong:8000
    originRequest:
      noTLSVerify: false

  - hostname: studio.domain.com
    service: http://supabase-studio:3000
    originRequest:
      noTLSVerify: false

  - service: http_status:404
EOF

# 4. Copier credentials
sudo cp /root/.cloudflared/<TUNNEL_ID>.json ./credentials.json
chmod 600 credentials.json

# 5. Cr√©er docker-compose.yml (similaire √† CertiDoc)
# ... (remplacer nom container : supabase-tunnel)

# 6. D√©marrer tunnel Supabase
docker compose up -d
```

---

## üìä Comparaison Ressources

| Configuration | Containers | RAM Totale | Gestion |
|---------------|------------|------------|---------|
| **100% G√©n√©rique** (10 apps) | 1 | 50 MB | ‚≠ê‚≠ê‚≠ê Tr√®s facile |
| **100% D√©di√©s** (10 apps) | 10 | 500 MB | ‚≠ê Complexe |
| **Hybride** (7 g√©n√©rique + 3 d√©di√©s) | 4 | 200 MB | ‚≠ê‚≠ê Moyen |

**Recommandation** : L'approche hybride est le **meilleur compromis** ! üéØ

---

## üóÇÔ∏è Structure Fichiers Hybride

```
/home/pi/
‚îú‚îÄ‚îÄ stacks/
‚îÇ   ‚îî‚îÄ‚îÄ cloudflare-tunnel-generic/        # Tunnel g√©n√©rique
‚îÇ       ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ       ‚îú‚îÄ‚îÄ config/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ apps.json
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ config.yml
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ credentials.json
‚îÇ       ‚îî‚îÄ‚îÄ scripts/
‚îÇ
‚îî‚îÄ‚îÄ tunnels/                              # Tunnels d√©di√©s
    ‚îú‚îÄ‚îÄ certidoc/
    ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
    ‚îÇ   ‚îú‚îÄ‚îÄ config.yml
    ‚îÇ   ‚îî‚îÄ‚îÄ credentials.json
    ‚îÇ
    ‚îî‚îÄ‚îÄ supabase/
        ‚îú‚îÄ‚îÄ docker-compose.yml
        ‚îú‚îÄ‚îÄ config.yml
        ‚îî‚îÄ‚îÄ credentials.json
```

---

## üê≥ Gestion Multi-Tunnels

### Lister tous les tunnels

```bash
# Via Cloudflare CLI
cloudflared tunnel list

# Via Docker
docker ps --filter "name=tunnel" --format "table {{.Names}}\t{{.Status}}"
```

**Sortie exemple** :
```
NAMES                   STATUS
cloudflared-tunnel      Up 2 hours (healthy)
certidoc-tunnel         Up 1 hour (healthy)
supabase-tunnel         Up 30 minutes (healthy)
```

---

### D√©marrer tous les tunnels

```bash
# Tunnel g√©n√©rique
cd /home/pi/stacks/cloudflare-tunnel-generic
docker compose up -d

# Tunnel CertiDoc
cd /home/pi/tunnels/certidoc
docker compose up -d

# Tunnel Supabase
cd /home/pi/tunnels/supabase
docker compose up -d
```

---

### Arr√™ter un tunnel sp√©cifique

```bash
# Arr√™ter seulement CertiDoc (autres tunnels continuent)
cd /home/pi/tunnels/certidoc
docker compose down
```

---

### Voir logs d'un tunnel sp√©cifique

```bash
# Logs CertiDoc uniquement
docker logs -f certidoc-tunnel

# Logs Supabase uniquement
docker logs -f supabase-tunnel

# Logs tunnel g√©n√©rique
docker logs -f cloudflared-tunnel
```

---

## üåê Configuration DNS Hybride

Tous les subdomains pointent vers **la m√™me IP publique** :

```
Type  Name         Content            Proxy
A     blog         203.0.113.42       DNS only (gris)
A     portfolio    203.0.113.42       DNS only (gris)
A     certidoc     203.0.113.42       DNS only (gris)
A     api          203.0.113.42       DNS only (gris)
A     studio       203.0.113.42       DNS only (gris)
```

**Cloudflare route automatiquement** chaque hostname vers le bon tunnel ! üéØ

---

## üîß Monitoring Hybride

### Script de monitoring global

```bash
#!/bin/bash
# monitor-all-tunnels.sh

echo "‚ïê‚ïê‚ïê Status Tunnels Cloudflare ‚ïê‚ïê‚ïê"
echo ""

tunnels=("cloudflared-tunnel" "certidoc-tunnel" "supabase-tunnel")

for tunnel in "${tunnels[@]}"; do
    if docker ps --filter "name=$tunnel" --format "{{.Names}}" | grep -q "$tunnel"; then
        status=$(docker inspect --format='{{.State.Health.Status}}' "$tunnel" 2>/dev/null || echo "unknown")
        echo "‚úÖ $tunnel : UP ($status)"
    else
        echo "‚ùå $tunnel : DOWN"
    fi
done

echo ""
echo "RAM utilis√©e par les tunnels :"
docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}" $(docker ps --filter "name=tunnel" -q)
```

**Utilisation** :
```bash
bash monitor-all-tunnels.sh
```

---

## üö® Troubleshooting Hybride

### Conflit de noms de containers

**Probl√®me** : `Error: container name already in use`

**Solution** : Utilisez des noms uniques pour chaque tunnel

```yaml
# ‚ùå Mauvais (conflit)
container_name: cloudflared-tunnel

# ‚úÖ Bon (unique)
container_name: certidoc-tunnel
container_name: supabase-tunnel
```

---

### Conflit de credentials

**Probl√®me** : Plusieurs tunnels utilisent le m√™me `credentials.json`

**Solution** : Chaque tunnel doit avoir **son propre fichier credentials**

```bash
# Tunnel 1
/home/pi/stacks/cloudflare-tunnel-generic/config/credentials.json

# Tunnel 2
/home/pi/tunnels/certidoc/credentials.json

# Tunnel 3
/home/pi/tunnels/supabase/credentials.json
```

---

### Un tunnel impacte les autres

**Probl√®me** : Red√©marrage d'un tunnel fait planter les autres

**Cause** : Les tunnels partagent probablement le m√™me r√©seau Docker

**Solution** : V√©rifiez l'isolation r√©seau

```bash
docker inspect certidoc-tunnel | grep -A 10 Networks
```

Chaque tunnel devrait avoir **ses propres r√©seaux** (ou partager seulement les r√©seaux n√©cessaires).

---

## üí° Best Practices Hybride

### 1. Organisation Claire

```
üìÅ Tunnel G√©n√©rique ‚Üí Apps non-critiques (blog, portfolio, d√©mos)
üìÅ Tunnels D√©di√©s ‚Üí Apps critiques (CertiDoc, Supabase, production)
```

### 2. Naming Convention

```yaml
# Tunnel g√©n√©rique
container_name: cloudflared-tunnel

# Tunnels d√©di√©s
container_name: {app-name}-tunnel
# Ex: certidoc-tunnel, supabase-tunnel, app-prod-tunnel
```

### 3. Monitoring S√©par√©

- **Tunnel g√©n√©rique** : Monitoring group√© (toutes apps ensemble)
- **Tunnels d√©di√©s** : Monitoring individuel (alertes par app)

### 4. Backups

```bash
# Sauvegarder configs tunnel g√©n√©rique
/home/pi/stacks/cloudflare-tunnel-generic/config/

# Sauvegarder configs tunnels d√©di√©s
/home/pi/tunnels/*/
```

### 5. Documentation

Cr√©ez un fichier `TUNNELS-MAP.md` :

```markdown
# Carte des Tunnels

## Tunnel G√©n√©rique (cloudflared-tunnel)
- blog.domain.com ‚Üí blog-app:80
- portfolio.domain.com ‚Üí portfolio-app:3000
- demo.domain.com ‚Üí demo-app:8080

## Tunnel CertiDoc (certidoc-tunnel)
- certidoc.domain.com ‚Üí certidoc-frontend:80

## Tunnel Supabase (supabase-tunnel)
- api.domain.com ‚Üí supabase-kong:8000
- studio.domain.com ‚Üí supabase-studio:3000
```

---

## üéØ Exemple R√©el : Startup avec 10 Apps

```
üì¶ Tunnel G√©n√©rique (apps internes/tests)
   ‚îú‚îÄ‚îÄ‚Üí docs.startup.com ‚Üí documentation:3000
   ‚îú‚îÄ‚îÄ‚Üí blog.startup.com ‚Üí ghost-blog:2368
   ‚îú‚îÄ‚îÄ‚Üí demo.startup.com ‚Üí demo-app:8080
   ‚îú‚îÄ‚îÄ‚Üí staging.startup.com ‚Üí staging-app:3001
   ‚îî‚îÄ‚îÄ‚Üí tools.startup.com ‚Üí internal-tools:5000

üîí Tunnel App Principale (certidoc-tunnel)
   ‚îî‚îÄ‚îÄ‚Üí app.startup.com ‚Üí certidoc-frontend:80

üîí Tunnel API Backend (api-tunnel)
   ‚îú‚îÄ‚îÄ‚Üí api.startup.com ‚Üí supabase-kong:8000
   ‚îî‚îÄ‚îÄ‚Üí graphql.startup.com ‚Üí hasura:8080

üîí Tunnel Admin (admin-tunnel)
   ‚îú‚îÄ‚îÄ‚Üí admin.startup.com ‚Üí admin-panel:3002
   ‚îî‚îÄ‚îÄ‚Üí monitoring.startup.com ‚Üí grafana:3000
```

**Ressources** :
- RAM Tunnels : 50 + 50 + 50 + 50 = **200 MB**
- vs Tout D√©di √© : 10 √ó 50 = **500 MB**
- **√âconomie : 300 MB RAM** (60%) üí∞

---

## ‚úÖ Conclusion

L'approche **hybride** est **LA solution optimale** pour :

- ‚úÖ **√âconomiser ressources** (RAM)
- ‚úÖ **Isoler apps critiques** (s√©curit√©)
- ‚úÖ **Simplifier gestion** (tunnel g√©n√©rique pour le reste)
- ‚úÖ **Flexibilit√© maximale** (ajuster selon besoins)

**Vous avez le meilleur des deux mondes !** üéâ

---

**Version** : 1.0.0
**Derni√®re mise √† jour** : 2025-01-13
**Auteur** : PI5-SETUP Project
