# üîê Supabase RLS Tools - Guide Complet

> **Outils pour g√©rer Row Level Security (RLS) sur votre instance Supabase self-hosted**

---

## ‚ö†Ô∏è IMPORTANT - PostgREST Configuration (v3.45+)

### RLS Policies RequirePostgREST Schema Configuration

**Si vous utilisez Supabase v3.44 ou ant√©rieur**, vos RLS policies ne fonctionneront PAS m√™me si elles sont correctement configur√©es !

**Probl√®me** : PostgREST doit avoir acc√®s au sch√©ma `auth` pour que `auth.uid()` fonctionne.

**Solution** : Assurez-vous que votre installation utilise v3.45+ du script de d√©ploiement, OU ex√©cutez :

```bash
# Pour installations existantes (v3.44 et ant√©rieures)
./fix-postgrest-schemas.sh

# Ce script met √† jour PGRST_DB_SCHEMAS de 'public' √† 'public,auth,storage'
```

**V√©rification** :
```bash
grep "PGRST_DB_SCHEMAS" ~/stacks/supabase/docker-compose.yml
# Doit afficher: PGRST_DB_SCHEMAS: public,auth,storage
```

‚úÖ **Installations v3.45+** : D√©j√† configur√© correctement, rien √† faire !

**üìñ D√©tails complets** : [CHANGELOG-POSTGREST-SCHEMAS-v3.45.md](../CHANGELOG-POSTGREST-SCHEMAS-v3.45.md)

---

## üìã Vue d'Ensemble

Ces scripts vous aident √† configurer et g√©rer les **Row Level Security policies** pour s√©curiser votre base de donn√©es Supabase.

### üéØ Pourquoi RLS ?

**Row Level Security (RLS)** est le m√©canisme de s√©curit√© de PostgreSQL qui contr√¥le quelles lignes un utilisateur peut voir/modifier dans une table.

**Sans RLS** :
```sql
SELECT * FROM users;
-- ‚ùå Retourne TOUTES les lignes (probl√®me de s√©curit√©!)
```

**Avec RLS** :
```sql
SELECT * FROM users;
-- ‚úÖ Retourne uniquement les lignes que l'utilisateur a le droit de voir
```

---

## üõ†Ô∏è Les 3 Outils

| Script | Usage | Description |
|--------|-------|-------------|
| **diagnose-rls.sh** | Diagnostic | Analyser l'√©tat actuel des RLS policies |
| **generate-rls-template.sh** | G√©n√©ration | Cr√©er des templates SQL de policies |
| **setup-rls-policies.sh** | Application | Appliquer les policies sur la base |

---

## üîç 1. Diagnostic RLS (`diagnose-rls.sh`)

### Usage

```bash
# Analyser toutes les tables
./diagnose-rls.sh

# Analyser une table sp√©cifique
./diagnose-rls.sh users

# Analyser une table avec d√©tails
./diagnose-rls.sh posts --verbose
```

### Ce que √ßa v√©rifie

‚úÖ **RLS activ√©/d√©sactiv√©** sur chaque table
‚úÖ **Policies existantes** (SELECT, INSERT, UPDATE, DELETE)
‚úÖ **Structure de la table** (colonnes user_id, email, team_id)
‚úÖ **Permissions PostgreSQL**
‚úÖ **Probl√®mes courants** (RLS activ√© sans policies, etc.)
‚úÖ **Suggestions** de policies adapt√©es

### Exemple de sortie

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  RLS DIAGNOSTIC: public.users
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

‚úì Table exists
‚úì RLS is ENABLED on public.users
‚úì Found 4 policies

=== Policies ===
Policy Name                    | Operation | Roles
-----------------------------------------------------------
Users can view their own users | SELECT    | authenticated
Users can insert their own ... | INSERT    | authenticated
Users can update their own ... | UPDATE    | authenticated
Users can delete their own ... | DELETE    | authenticated

=== Table Columns ===
Column      | Type | Nullable
--------------------------------
id          | uuid | NO
email       | text | NO
user_id     | uuid | YES
created_at  | timestamp | NO

=== RLS-relevant Columns ===
‚úì Has 'user_id' column (good for user-based policies)
‚úì Has 'email' column (good for email-based policies)

=== Common Issues Check ===
‚úì No common issues detected

=== Suggested Policies ===
üí° Recommended: Basic user-based policies
   ./generate-rls-template.sh users --basic
```

---

## üìù 2. G√©n√©rateur de Templates (`generate-rls-template.sh`)

### Usage

```bash
# Template basique (user_id = auth.uid())
./generate-rls-template.sh users --basic

# Lecture publique, √©criture par propri√©taire
./generate-rls-template.sh posts --public-read

# Isolation stricte (chaque user voit uniquement ses donn√©es)
./generate-rls-template.sh profiles --owner-only

# Policies bas√©es sur email
./generate-rls-template.sh invitations --email

# Policies bas√©es sur r√¥les (admin/manager/user)
./generate-rls-template.sh documents --role

# Policies bas√©es sur √©quipes/organisations
./generate-rls-template.sh projects --team

# Template personnalis√© avec exemples
./generate-rls-template.sh custom_table --custom
```

### Types de Policies Disponibles

#### 1Ô∏è‚É£ **Basic** (Par d√©faut)

**Cas d'usage** : Tables avec colonne `user_id`

**Comportement** :
- Users peuvent voir/modifier uniquement leurs propres lignes
- Bas√© sur `user_id = auth.uid()`

**Exemple g√©n√©r√©** :
```sql
CREATE POLICY "Users can view their own users"
ON public.users FOR SELECT TO authenticated
USING (user_id = auth.uid());
```

**Parfait pour** : users, profiles, settings

---

#### 2Ô∏è‚É£ **Public Read**

**Cas d'usage** : Contenu public en lecture, priv√© en √©criture

**Comportement** :
- N'importe qui peut lire (m√™me anonyme)
- Seuls les propri√©taires peuvent modifier

**Exemple g√©n√©r√©** :
```sql
-- Tout le monde peut lire
CREATE POLICY "Anyone can view posts"
ON public.posts FOR SELECT TO public
USING (true);

-- Seuls les propri√©taires peuvent modifier
CREATE POLICY "Users can update their own posts"
ON public.posts FOR UPDATE TO authenticated
USING (user_id = auth.uid());
```

**Parfait pour** : posts, articles, comments (lecture publique)

---

#### 3Ô∏è‚É£ **Owner Only** (Isolation stricte)

**Cas d'usage** : Donn√©es tr√®s sensibles, isolation totale

**Comportement** :
- Utilisateurs compl√®tement isol√©s
- Aucune visibilit√© sur les donn√©es des autres

**Exemple g√©n√©r√©** :
```sql
CREATE POLICY "Users can only access their own data"
ON public.private_data FOR ALL TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());
```

**Parfait pour** : financial_records, medical_data, private_notes

---

#### 4Ô∏è‚É£ **Email-based**

**Cas d'usage** : Tables avec colonne `email` au lieu de `user_id`

**Comportement** :
- Bas√© sur `email = auth.jwt()->>'email'`
- Utile pour invitations, notifications

**Exemple g√©n√©r√©** :
```sql
CREATE POLICY "Users can view their own invitations"
ON public.email_invites FOR SELECT TO authenticated
USING (email = (auth.jwt() ->> 'email'));
```

**Parfait pour** : email_invitations, notifications, subscriptions

---

#### 5Ô∏è‚É£ **Role-based**

**Cas d'usage** : Diff√©rents niveaux d'acc√®s (admin, manager, user)

**Comportement** :
- Admins : acc√®s total
- Managers : peuvent voir/modifier tout
- Users : lecture seule

**Exemple g√©n√©r√©** :
```sql
CREATE POLICY "Admins can do anything"
ON public.documents FOR ALL TO authenticated
USING ((auth.jwt() ->> 'role') = 'admin');

CREATE POLICY "Managers can manage"
ON public.documents FOR ALL TO authenticated
USING (
    (auth.jwt() ->> 'role') IN ('admin', 'manager')
    OR user_id = auth.uid()
);
```

**Parfait pour** : admin_panel, reports, analytics

**‚ö†Ô∏è Note** : N√©cessite d'ajouter `role` aux JWT claims

---

#### 6Ô∏è‚É£ **Team-based**

**Cas d'usage** : Applications multi-tenant (SaaS, organisations)

**Comportement** :
- Utilisateurs d'une m√™me √©quipe voient les m√™mes donn√©es
- Isolation entre √©quipes

**Exemple g√©n√©r√©** :
```sql
CREATE POLICY "Users can view team data"
ON public.projects FOR SELECT TO authenticated
USING (
    team_id = (auth.jwt() ->> 'team_id')::uuid
    OR user_id = auth.uid()
);
```

**Parfait pour** : projects, team_documents, shared_resources

**‚ö†Ô∏è Note** : N√©cessite colonne `team_id` et JWT claim

---

#### 7Ô∏è‚É£ **Custom**

**Cas d'usage** : Besoins sp√©cifiques complexes

**Contient** :
- Exemples de policies temporelles (30 derniers jours)
- Policies conditionnelles (status = 'published')
- Policies avec sous-requ√™tes
- Exemples de bypass pour service_role

**Parfait pour** : cas d'usage uniques

---

## ‚öôÔ∏è 3. Application des Policies (`setup-rls-policies.sh`)

### Usage

```bash
# Appliquer policies √† toutes les tables (mode interactif)
./setup-rls-policies.sh

# Appliquer √† une table sp√©cifique
./setup-rls-policies.sh --table users

# Pr√©visualiser sans ex√©cuter
./setup-rls-policies.sh --dry-run

# Appliquer un fichier SQL personnalis√©
./setup-rls-policies.sh --custom rls-policies-users-basic.sql

# Lister les policies actuelles
./setup-rls-policies.sh --list

# D√©sactiver RLS (‚ö†Ô∏è use with caution!)
./setup-rls-policies.sh --table users --disable
```

### Workflow Automatique

Le script :

1. ‚úÖ **D√©couvre** toutes les tables dans le sch√©ma `public`
2. ‚úÖ **D√©tecte** les colonnes pertinentes (user_id, email, team_id)
3. ‚úÖ **Active** RLS sur chaque table
4. ‚úÖ **Cr√©e** les policies appropri√©es automatiquement :
   - Si `user_id` existe ‚Üí policies bas√©es sur `auth.uid()`
   - Si `email` existe ‚Üí policies bas√©es sur `auth.jwt()->>'email'`
5. ‚úÖ **V√©rifie** et affiche le statut final

### Exemple Complet

```bash
# 1. Diagnostic initial
./diagnose-rls.sh

# 2. G√©n√©rer un template personnalis√©
./generate-rls-template.sh users --basic

# 3. √âditer le template si n√©cessaire
nano rls-policies-users-basic.sql

# 4. Appliquer le template
./setup-rls-policies.sh --custom rls-policies-users-basic.sql

# 5. V√©rifier
./diagnose-rls.sh users
```

---

## üöÄ Workflows Typiques

### Workflow 1 : Nouvelle Application (Quick Start)

**Situation** : Vous avez des tables, aucune RLS configur√©e

```bash
# 1. Voir l'√©tat actuel
./diagnose-rls.sh

# 2. Appliquer policies par d√©faut √† toutes les tables
./setup-rls-policies.sh

# 3. V√©rifier
./diagnose-rls.sh --all
```

**R√©sultat** : RLS activ√© avec policies basiques sur toutes les tables

---

### Workflow 2 : Table Sp√©cifique

**Situation** : Vous voulez configurer une table pr√©cise

```bash
# 1. Analyser la table
./diagnose-rls.sh email_invites

# 2. G√©n√©rer template adapt√© (email-based)
./generate-rls-template.sh email_invites --email

# 3. √âditer si n√©cessaire
nano rls-policies-email_invites-email.sql

# 4. Appliquer
./setup-rls-policies.sh --custom rls-policies-email_invites-email.sql

# 5. Tester depuis votre app
# supabase.from('email_invites').select('*')
```

---

### Workflow 3 : Policies Avanc√©es (Multi-tenant)

**Situation** : Application SaaS avec organisations

```bash
# 1. G√©n√©rer template team-based
./generate-rls-template.sh projects --team

# 2. √âditer pour adapter √† votre sch√©ma
nano rls-policies-projects-team.sql

# Modifier pour utiliser votre colonne 'organization_id'
# sed -i 's/team_id/organization_id/g' rls-policies-projects-team.sql

# 3. Appliquer
./setup-rls-policies.sh --custom rls-policies-projects-team.sql

# 4. Configurer JWT claims (voir ci-dessous)
```

**Configurer JWT claims** :

```sql
-- Trigger pour ajouter organization_id au JWT
CREATE OR REPLACE FUNCTION public.custom_access_token_hook(event jsonb)
RETURNS jsonb AS $$
DECLARE
  claims jsonb;
  user_org_id uuid;
BEGIN
  -- Get user's organization_id
  SELECT organization_id INTO user_org_id
  FROM public.users
  WHERE id = (event->>'user_id')::uuid;

  -- Add to claims
  claims := event->'claims';
  claims := jsonb_set(claims, '{organization_id}', to_jsonb(user_org_id));

  event := jsonb_set(event, '{claims}', claims);
  RETURN event;
END;
$$ LANGUAGE plpgsql;
```

---

### Workflow 4 : D√©bug Erreur 403 (Permission Denied)

**Situation** : Votre app re√ßoit 403 Forbidden

```bash
# 1. Identifier la table concern√©e
# Regarder les logs : "permission denied for table XXX"

# 2. Diagnostic complet
./diagnose-rls.sh posts

# V√©rifier :
# - ‚ùå RLS is DISABLED ‚Üí Activer RLS
# - ‚ùå No policies found ‚Üí Cr√©er policies
# - ‚úÖ Policies exist ‚Üí V√©rifier la logique

# 3. Si RLS activ√© mais pas de policies
./generate-rls-template.sh posts --public-read
./setup-rls-policies.sh --custom rls-policies-posts-public-read.sql

# 4. Si policies existent mais ne fonctionnent pas
# V√©rifier dans le template g√©n√©r√© :
# - Colonne user_id existe ?
# - auth.uid() retourne bien l'ID user ?
# - JWT claims corrects ?

# 5. Test en SQL direct
# ssh pi@192.168.1.74
# docker exec -it supabase-db psql -U postgres -d postgres
# SET ROLE authenticated;
# SET request.jwt.claims TO '{"sub": "YOUR_USER_ID"}';
# SELECT * FROM posts;
```

---

## üìö Exemples de Cas d'Usage

### Cas 1 : Blog Public

**Tables** :
- `posts` : Articles (lecture publique, √©criture par auteur)
- `comments` : Commentaires (lecture publique, √©criture par user authentifi√©)
- `authors` : Profils auteurs (lecture publique)

**Policies** :

```bash
# Posts - lecture publique, √©criture par auteur
./generate-rls-template.sh posts --public-read
./setup-rls-policies.sh --custom rls-policies-posts-public-read.sql

# Comments - idem
./generate-rls-template.sh comments --public-read
./setup-rls-policies.sh --custom rls-policies-comments-public-read.sql

# Authors - lecture publique, √©criture par propri√©taire
./generate-rls-template.sh authors --public-read
./setup-rls-policies.sh --custom rls-policies-authors-public-read.sql
```

---

### Cas 2 : Application SaaS (Multi-tenant)

**Tables** :
- `organizations` : Les organisations (chaque user voit la sienne)
- `team_members` : Membres d'√©quipe
- `projects` : Projets (partag√©s dans l'organisation)
- `tasks` : T√¢ches

**Policies** :

```bash
# Organizations - user voit sa propre org
./generate-rls-template.sh organizations --owner-only

# Projects - team-based
./generate-rls-template.sh projects --team
# √âditer pour utiliser organization_id
sed -i 's/team_id/organization_id/g' rls-policies-projects-team.sql
./setup-rls-policies.sh --custom rls-policies-projects-team.sql

# Tasks - team-based
./generate-rls-template.sh tasks --team
sed -i 's/team_id/organization_id/g' rls-policies-tasks-team.sql
./setup-rls-policies.sh --custom rls-policies-tasks-team.sql
```

---

### Cas 3 : Application E-commerce

**Tables** :
- `products` : Produits (lecture publique)
- `orders` : Commandes (priv√©es)
- `cart_items` : Panier (priv√©)
- `reviews` : Avis (lecture publique, √©criture apr√®s achat)

**Policies** :

```bash
# Products - lecture publique, admin peut modifier
./generate-rls-template.sh products --custom
# √âditer pour permettre :
# - SELECT : public (true)
# - INSERT/UPDATE/DELETE : admin only

# Orders - strict owner only
./generate-rls-template.sh orders --owner-only

# Cart items - owner only
./generate-rls-template.sh cart_items --owner-only

# Reviews - custom (peut reviewer si a achet√©)
./generate-rls-template.sh reviews --custom
# √âditer pour ajouter :
# USING (
#   user_id = auth.uid()
#   OR product_id IN (
#     SELECT product_id FROM orders
#     WHERE user_id = auth.uid() AND status = 'completed'
#   )
# )
```

---

## ‚ö†Ô∏è Points d'Attention

### 1. **Service Role Bypass**

Le r√¥le `service_role` **bypass RLS** par d√©faut.

```javascript
// ‚ùå BAD: Service role depuis le frontend
const supabase = createClient(url, SERVICE_KEY) // Expose la cl√© admin!

// ‚úÖ GOOD: Anon key depuis le frontend
const supabase = createClient(url, ANON_KEY) // Respecte RLS
```

---

### 2. **JWT Claims personnalis√©s**

Pour policies bas√©es sur `team_id`, `role`, etc., vous devez ajouter ces champs au JWT.

**M√©thode 1 : Database Trigger** (recommand√©)

```sql
CREATE OR REPLACE FUNCTION public.custom_access_token_hook(event jsonb)
RETURNS jsonb AS $$
DECLARE
  claims jsonb;
  user_role text;
  user_team_id uuid;
BEGIN
  SELECT role, team_id INTO user_role, user_team_id
  FROM public.users
  WHERE id = (event->>'user_id')::uuid;

  claims := event->'claims';
  claims := jsonb_set(claims, '{role}', to_jsonb(user_role));
  claims := jsonb_set(claims, '{team_id}', to_jsonb(user_team_id));

  event := jsonb_set(event, '{claims}', claims);
  RETURN event;
END;
$$ LANGUAGE plpgsql;
```

**M√©thode 2 : Auth metadata** (via Supabase Studio)

Dans Studio ‚Üí Authentication ‚Üí Users ‚Üí Edit User ‚Üí User Metadata :
```json
{
  "role": "manager",
  "team_id": "uuid-here"
}
```

---

### 3. **Performance**

Les policies avec sous-requ√™tes peuvent √™tre lentes.

**‚ùå Slow** :
```sql
USING (
  team_id IN (
    SELECT team_id FROM team_members WHERE user_id = auth.uid()
  )
)
```

**‚úÖ Faster** :
```sql
-- Ajouter team_id directement au JWT
USING (team_id = (auth.jwt() ->> 'team_id')::uuid)
```

---

### 4. **Debugging**

Pour tester une policy en SQL :

```sql
-- Se connecter √† la DB
docker exec -it supabase-db psql -U postgres -d postgres

-- Simuler un user authentifi√©
SET ROLE authenticated;
SET request.jwt.claims TO '{
  "sub": "user-uuid-here",
  "email": "user@example.com",
  "role": "user"
}';

-- Tester la requ√™te
SELECT * FROM your_table;

-- Reset
RESET ROLE;
RESET request.jwt.claims;
```

---

## üìñ Ressources Compl√©mentaires

### Documentation Officielle

- [Supabase RLS Docs](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL RLS](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [JWT Claims](https://supabase.com/docs/guides/auth/managing-user-data#using-triggers)

### Vid√©os Recommand√©es

- [Supabase RLS Explained (YouTube)](https://www.youtube.com/results?search_query=supabase+rls+tutorial)
- [Multi-tenant RLS](https://www.youtube.com/results?search_query=supabase+multi+tenant)

---

## üÜò D√©pannage

### Erreur : "permission denied for table XXX"

**Cause** : RLS activ√© sans policies ou policies trop restrictives

**Solution** :
```bash
./diagnose-rls.sh XXX
./generate-rls-template.sh XXX --basic
./setup-rls-policies.sh --custom rls-policies-XXX-basic.sql
```

---

### Erreur : "function auth.uid() does not exist"

**Cause** : Installation Supabase incompl√®te

**Solution** :
```bash
# V√©rifier que le sch√©ma auth existe
docker exec -e PGPASSWORD="$POSTGRES_PASSWORD" supabase-db \
  psql -U postgres -d postgres -c "\dn"

# Doit afficher : auth | ...
```

---

### Policies ne fonctionnent pas (toujours 403)

**Checklist** :

1. ‚úÖ RLS activ√© ? `./diagnose-rls.sh table_name`
2. ‚úÖ Policies cr√©√©es ? `./setup-rls-policies.sh --list`
3. ‚úÖ Colonne `user_id` existe ? V√©rifier structure table
4. ‚úÖ `auth.uid()` retourne bien l'UUID user ? Tester en SQL
5. ‚úÖ JWT claims corrects ? V√©rifier token dans app

---

## üìù Checklist Migration Production

Avant de d√©ployer en production :

- [ ] Toutes les tables ont RLS activ√© (`./diagnose-rls.sh --all`)
- [ ] Policies test√©es avec diff√©rents users
- [ ] Service key s√©curis√© (jamais expos√© au frontend)
- [ ] JWT claims configur√©s si n√©cessaire
- [ ] Backup de la base avant application (`pg_dump`)
- [ ] Rollback plan pr√©par√©
- [ ] Logs activ√©s pour tracer les 403
- [ ] Tests d'int√©gration avec RLS passants

---

**Version** : 1.0
**Date** : 2025-10-10
**Auteur** : Claude Code Assistant

**üîê S√©curisez votre Supabase avec confiance !**
